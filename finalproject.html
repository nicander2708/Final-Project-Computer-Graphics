<!DOCTYPE html>
<html>
<head>
	<title>Final Project</title>
	<script src="https://preview.babylonjs.com/babylon.js"></script>
	<script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
	<script src="https://code.jquery.com/pep/0.4.3/pep.js"></script>
	<script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>
	<!-- <script src="assets/babylon.js"></script> -->
<!-- <script src="car.js"></script>
	<script src="control.js"></script> -->



	<style>
		html, body {
			overflow: hidden;
			width: 100%;
			height: 100%;
			margin: 0;
			padding: 0;
		}

		#render {
			width: 100%;
			height: 100%;
			touch-action: none;
		}
	</style>
</head>

<body>

	<canvas id="render" touch-action="none">
		<script>
			if (BABYLON.Engine.isSupported()) {
				var canvas = document.getElementById("render");
				var engine = new BABYLON.Engine(canvas, true);

				//load map
				BABYLON.SceneLoader.Load("assets/", "map.babylon", engine, function (scene) {
					scene.executeWhenReady(function () {
						// Skybox
						var skybox = BABYLON.Mesh.CreateBox("skybox", 700.0, scene);
						var skyboxMaterial = new BABYLON.StandardMaterial("skyboxMat", scene);
						skyboxMaterial.backFaceCulling = false;
						skyboxMaterial.disableLighting = true;
						skybox.material = skyboxMaterial;
						skybox.infiniteDistance = false;
						skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
						skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
						skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("assets/textures/TropicalSunnyDay/TropicalSunnyDay", scene);
						skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;

						//camera
						var camera = new BABYLON.FollowCamera("FreeCamera", new BABYLON.Vector3(0, 15, -10), scene);
						//   camera.setTarget(BABYLON.Vector3.Zero());
						camera.attachControl(canvas, true);
						var gameUI = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("myUI");
						gameUI.layer.layerMask = 1;
						gameUI.rootContainer.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
						gameUI.rootContainer.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
						gameUI.rootContainer.left = "-40%";
						gameUI.rootContainer.top = "-45%";
						var score = 0; 
                        var score_text = new BABYLON.GUI.TextBlock('Score');
                        score_text.color ="Blue";
                        score_text.fontsize = 32;                   
                        gameUI.addControl(score_text);
						camera.checkCollisions = scene.activeCamera.checkCollisions;
						camera.applyGravity = scene.activeCamera.applyGravity;
						camera.ellipsoid = scene.activeCamera.ellipsoid;
						scene.activeCamera = camera;
						scene.activeCamera.attachControl(canvas);


						//Enable global collisions
						scene.collisionsEnabled = true;

						//Enable camera collisions
						camera.checkCollisions = true;

						var wall = BABYLON.MeshBuilder.CreateBox('wall', { width: 5, height: 2}, scene);
						wall.position =  new BABYLON.Vector3(28,0,-35);
						wall.checkCollisions = true;

						var wall1 = BABYLON.MeshBuilder.CreateBox('wall1', { width: 5.5, height: 2}, scene);
						wall1.position =  new BABYLON.Vector3(83.3,0,-35);
						wall1.checkCollisions = true;

						var wall2 = BABYLON.MeshBuilder.CreateBox('wall2', { width: 5.5, height: 2}, scene);
						wall2.position =  new BABYLON.Vector3(83,0,-155);
						wall2.checkCollisions = true;

						var wall3 = BABYLON.MeshBuilder.CreateBox('wall3', { width: 4.4, height: 2}, scene);
						wall3.position =  new BABYLON.Vector3(27.4,0,-155);
						wall3.checkCollisions = true;

						var wall4 = BABYLON.MeshBuilder.CreateBox('wall4', { width: 5.5, height: 2}, scene);
						wall4.position =  new BABYLON.Vector3(139,0,-155);
						wall4.checkCollisions = true;

						var wall5 = BABYLON.MeshBuilder.CreateBox('wall5', { width: 5, height: 2}, scene);
						wall5.position =  new BABYLON.Vector3(138.9,0,-35);
						wall5.checkCollisions = true;

						var wall6 = BABYLON.MeshBuilder.CreateBox('wall6', { width: 5, height: 2}, scene);
						wall6.position =  new BABYLON.Vector3(27.8,0,-100);
						wall6.checkCollisions = true;

						var wall7 = BABYLON.MeshBuilder.CreateBox('wall7', { width: 5, height: 2}, scene);
						wall7.position =  new BABYLON.Vector3(83.3,0,-100);
						wall7.checkCollisions = true;

						var wall8 = BABYLON.MeshBuilder.CreateBox('wall8', { width: 4.9, height: 2}, scene);
						wall8.position =  new BABYLON.Vector3(138.9,0,-100);
						wall8.checkCollisions = true;

						var care1;
						BABYLON.SceneLoader.ImportMesh("", "models/assets/car/", "1967-shelby-ford-mustang.babylon", scene, function (newMeshes, particleSystems, skeletons) {



							care1 = newMeshes[1];
							care1.collisionsEnabled = true;
							care1.checkCollisions = true;



							care1.position.z = -75.73;
							care1.position.x = 28;
							care1.position.y = 0;


							care1.scaling.y = 300;
							care1.scaling.x = 300;
							care1.scaling.z = 300;

							camera.radius = -10;

							// camera.heightOffset = 15;
							// camera.rotationOffset = 52.5;

							camera.position =  new BABYLON.Vector3(20,55,0);
							camera.lockedTarget = care1;

							care1.applyGravity = true;

							care1.ellipsoid = new BABYLON.Vector3(2, 0.2, 2);
							care1.ellipsoidOffset = new BABYLON.Vector3(0, 1, 0);

							care1.onCollide = function(collidedMesh){
                           if(collidedMesh.uniqueId === wall.uniqueId){
                              wall.position = new BABYLON.Vector3(28,-10,-55);
                              score++;
                              score_text.text = "Score " + score;
                           };
                           if(collidedMesh.uniqueId === wall1.uniqueId){
                              wall1.position = new BABYLON.Vector3(83.3,-10,-35);
                              score++;
                              score_text.text = "Score " + score;
                           };
                           if(collidedMesh.uniqueId === wall2.uniqueId){
                              wall2.position = new BABYLON.Vector3(83,-5,-155);
                              score++;
                              score_text.text = "Score " + score;
                           };
                           if(collidedMesh.uniqueId === wall3.uniqueId){
                              wall3.position = new BABYLON.Vector3(27.4,-5,-155);
                              score++;
                              score_text.text = "Score " + score;
                           };
                           if(collidedMesh.uniqueId === wall4.uniqueId){
                              wall4.position = new BABYLON.Vector3(139,-5,-155);
                              score++;
                              score_text.text = "Score " + score;
                           };
                           if(collidedMesh.uniqueId === wall5.uniqueId){
                              wall5.position = new BABYLON.Vector3(138.9,-5,-35);
                              score++;
                              score_text.text = "Score " + score;
                           };
                           if(collidedMesh.uniqueId === wall6.uniqueId){
                              wall6.position = new BABYLON.Vector3(27.8,-5,-100);
                              score++;
                              score_text.text = "Score " + score;
                           };
                           if(collidedMesh.uniqueId === wall7.uniqueId){
                              wall7.position = new BABYLON.Vector3(83.3,-5,-100);
                              score++;
                              score_text.text = "Score " + score;
                           };
                           if(collidedMesh.uniqueId === wall8.uniqueId){
                              wall8.position = new BABYLON.Vector3(138.9,-5,-100);
                              score++;
                              score_text.text = "Score " + score;
                           };
                           if(score == 9){
                           alert(" Congratulations, you have completed the driving course");
                        }
                        };

							var map = {};
							scene.actionManager = new BABYLON.ActionManager(scene);

							scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyDownTrigger, function(evt){
								map[evt.sourceEvent.key] = evt.sourceEvent.type == "keydown";
							}));

							scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyUpTrigger, function(evt){
								map[evt.sourceEvent.key] = evt.sourceEvent.type == "keydown";
							}));
							var axis = new BABYLON.Vector3(0, -0.6, 0);
							var angle = -1.57;
							var angle1 = 1.57;
							var angle2 = Math.PI*2;
							var angle3 = Math.PI;

							// var right = new BABYLON.Quaternion.RotationAxis(axis, angle);
							// var left = new BABYLON.Quaternion.RotationAxis(axis, angle1);
							// var up = new BABYLON.Quaternion.RotationAxis(axis,angle2);
							// var down = new BABYLON.Quaternion.RotationAxis(axis,angle3)
							var distance = 0.5;
							scene.registerAfterRender(function(){
								if(map["w"]){

									care1.moveWithCollisions(new BABYLON.Vector3(distance * care1.forward.x,0, distance * care1.forward.z));
									console.log(care1.forward);
								}
								if(map["s"]){
									care1.moveWithCollisions(new BABYLON.Vector3(-distance * care1.forward.x,0, -distance * care1.forward.z));
								}
								if(map["d"] && map["w"] || map["s"]){
									care1.rotate(BABYLON.Axis.Y, Math.PI / 100, BABYLON.Space.WORLD)
								}
								if(map["a"] && map["w"] || map["s"]){
									care1.rotate(BABYLON.Axis.Y, -Math.PI / 100, BABYLON.Space.WORLD)
								}
								else {

								}
							});
						});
						  scene.debugLayer.show();
						// Once the scene is loaded, just register a render loop to render it
						engine.runRenderLoop(function() {
							scene.render();
						});
					});
				});
			}
		</script>
	</body>
</html>
